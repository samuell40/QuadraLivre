generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Usuario {
  id          Int       @id @default(autoincrement())
  nome        String
  email       String    @unique
  telefone    String?
  permissaoId Int
  foto        String?   @db.VarChar(2048)
  quadraId    Int?
  ativo       Boolean   @default(true)
  deletedAt   DateTime?
  quadra               Quadra?          @relation(fields: [quadraId], references: [id])
  permissao            Permissao        @relation(fields: [permissaoId], references: [id])
  jogadorId            Int?             @unique
  jogador              Jogador?         @relation(fields: [jogadorId], references: [id])
  agendamentos         Agendamento[]
  times                UsuarioTime[]
  partidasCriadas      Partida[]        @relation("UsuarioCriador")
  partidasParticipando PartidaUsuario[]

  avisosCriados  Aviso[]
  avisosLidos    AvisoLeitura[]
  treinadorTimes TreinadorTime[]
}

model Permissao {
  id               Int              @id @default(autoincrement())
  descricao        String
  usuarios         Usuario[]
  partidasUsuarios PartidaUsuario[]
}

model Quadra {
  id           Int             @id @default(autoincrement())
  nome         String
  foto         String?         @db.VarChar(2048)
  endereco     String?
  interditada  Boolean         @default(false)
  usuarios     Usuario[]
  modalidades  Modalidade[]    @relation("QuadraModalidade")
  agendamentos Agendamento[]
  partidas     Partida[]
  campeonatos  Campeonato[]
  avisos       Aviso[]
  horarios     HorarioQuadra[]
}

enum TipoAgendamento {
  AMISTOSO
  TREINO
  EVENTO
  OUTRO
}

model Agendamento {
  id                Int             @id @default(autoincrement())
  dia               Int
  mes               Int
  ano               Int
  hora              Int
  datahora          DateTime?
  duracao           Int             @default(1)
  status            String          @default("Pendente")
  tipo              TipoAgendamento @default(TREINO)
  usuarioId         Int?
  quadraId          Int?
  modalidadeId      Int?
  timeId            Int?
  codigoVerificacao String?         @unique
  motivoRecusa      String?
  deletedAt         DateTime?
  fixo              Boolean         @default(false)
  usuario           Usuario?        @relation(fields: [usuarioId], references: [id])
  quadra            Quadra?         @relation(fields: [quadraId], references: [id])
  modalidade        Modalidade?     @relation("AgendamentoModalidade", fields: [modalidadeId], references: [id])
  time              Time?           @relation("TimeAgendamentos", fields: [timeId], references: [id])
  campeonatoId      Int?
  campeonato        Campeonato?     @relation(fields: [campeonatoId], references: [id])
}

model Modalidade {
  id           Int             @id @default(autoincrement())
  nome         String          @unique
  ativo        Boolean         @default(true)
  deletedAt    DateTime?
  times        Time[]
  quadras      Quadra[]        @relation("QuadraModalidade")
  agendamentos Agendamento[]   @relation("AgendamentoModalidade")
  partidas     Partida[]
  campeonatos  Campeonato[]
  funcoes      FuncaoJogador[]
  jogadorTimes JogadorTime[]
}

enum TipoCampeonato {
  PONTOS_CORRIDOS
  PONTOS_CORRIDOS_ELIMINATORIAS
  ELIMINATORIAS
}

model Campeonato {
  id                 Int              @id @default(autoincrement())
  nome               String
  tipo               TipoCampeonato
  anexos             String?          @db.Text
  foto               String?          @db.VarChar(2048)
  regras             Json?
  dataInicio         DateTime
  dataFim            DateTime?
  status             String           @default("EM_ANDAMENTO")
  modalidadeId       Int
  quadraId           Int?
  ativo              Boolean          @default(true)
  deletedAt          DateTime?
  ordemClassificacao Json?
  modalidade         Modalidade       @relation(fields: [modalidadeId], references: [id])
  quadra             Quadra?          @relation(fields: [quadraId], references: [id])
  fases              Fase[]
  times              CampeonatoTime[]
  partidas           Partida[]
  placares           Placar[]
  agendamentos       Agendamento[]
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt
}

model CampeonatoTime {
  campeonatoId Int
  timeId       Int
  ativo        Boolean    @default(true)
  deletedAt    DateTime?
  campeonato   Campeonato @relation(fields: [campeonatoId], references: [id])
  time         Time       @relation(fields: [timeId], references: [id])

  @@id([campeonatoId, timeId])
}

model Fase {
  id           Int        @id @default(autoincrement())
  nome         String
  campeonatoId Int
  ativo        Boolean    @default(true)
  deletedAt    DateTime?
  campeonato   Campeonato @relation(fields: [campeonatoId], references: [id])
  rodadas      Rodada[]
  placares     Placar[]
  partidas     Partida[]
}

model Rodada {
  id       Int       @id @default(autoincrement())
  nome     String
  faseId   Int
  ativo    Boolean   @default(true)
  fase     Fase      @relation(fields: [faseId], references: [id])
  partidas Partida[]

  @@unique([faseId, nome])
}

model Time {
  id               Int              @id @default(autoincrement())
  nome             String
  foto             String?          @db.VarChar(2048)
  modalidadeId     Int
  deletedAt        DateTime?
  ativo            Boolean          @default(true)
  modalidade       Modalidade       @relation(fields: [modalidadeId], references: [id])
  usuarios         UsuarioTime[]
  campeonatos      CampeonatoTime[]
  placares         Placar[]
  partidasA        Partida[]        @relation("TimeAPartidas")
  partidasB        Partida[]        @relation("TimeBPartidas")
  agendamentos     Agendamento[]    @relation("TimeAgendamentos")
  jogadores        JogadorTime[]
  treinador        TreinadorTime?
  jogadoresPartida JogadorPartida[]
}

enum StatusPartida {
  AGENDADA
  EM_ANDAMENTO
  FINALIZADA
  CANCELADA
  DELETADA
}

model Partida {
  id                    Int              @id @default(autoincrement())
  data                  DateTime         @default(now())
  status                StatusPartida    @default(AGENDADA)
  campeonatoId          Int?
  faseId                Int?
  rodadaId              Int?
  modalidadeId          Int
  quadraId              Int?
  timeAId               Int
  timeBId               Int
  campeonato            Campeonato?      @relation(fields: [campeonatoId], references: [id])
  fase                  Fase?            @relation(fields: [faseId], references: [id])
  rodada                Rodada?          @relation(fields: [rodadaId], references: [id])
  modalidade            Modalidade       @relation(fields: [modalidadeId], references: [id])
  quadra                Quadra?          @relation(fields: [quadraId], references: [id])
  timeA                 Time             @relation("TimeAPartidas", fields: [timeAId], references: [id])
  timeB                 Time             @relation("TimeBPartidas", fields: [timeBId], references: [id])
  pontosTimeA           Int              @default(0)
  pontosTimeB           Int              @default(0)
  woTimeA               Boolean          @default(false)
  woTimeB               Boolean          @default(false)
  tempoSegundos         Int              @default(0)
  inicioPartida         DateTime?
  cartoesAmarelosTimeA  Int              @default(0)
  cartoesVermelhosTimeA Int              @default(0)
  cartoesAmarelosTimeB  Int              @default(0)
  cartoesVermelhosTimeB Int              @default(0)
  faltasTimeA           Int              @default(0)
  faltasTimeB           Int              @default(0)
  substituicoesTimeA    Int              @default(0)
  substituicoesTimeB    Int              @default(0)
  usuarioCriadorId      Int
  usuarioCriador        Usuario          @relation("UsuarioCriador", fields: [usuarioCriadorId], references: [id])
  jogadoresPartida      JogadorPartida[]
  participantes         PartidaUsuario[]
  sets                  SetPartida[]
  createdAt             DateTime         @default(now())
  updatedAt             DateTime         @updatedAt
}

model SetPartida {
  id        Int     @id @default(autoincrement())
  partidaId Int
  numero    Int
  pontosA   Int
  pontosB   Int
  partida   Partida @relation(fields: [partidaId], references: [id], onDelete: Cascade)

  @@unique([partidaId, numero])
}

model TreinadorTime {
  id        Int       @id @default(autoincrement())
  usuarioId Int
  timeId    Int
  ativo     Boolean   @default(true)
  deletedAt DateTime?
  usuario   Usuario   @relation(fields: [usuarioId], references: [id])
  time      Time      @relation(fields: [timeId], references: [id])

  @@unique([timeId]) //1 treinador por time
}

model Jogador {
  id        Int              @id @default(autoincrement())
  nome      String
  foto      String?          @db.VarChar(2048)
  funcaoId  Int?
  usuario   Usuario?
  ativo     Boolean          @default(true)
  deletedAt DateTime?
  funcao    FuncaoJogador?   @relation(fields: [funcaoId], references: [id])
  atuacoes  JogadorPartida[]
  times     JogadorTime[] // relação de times por modalidade
}

model JogadorTime {
  id           Int       @id @default(autoincrement())
  jogadorId    Int
  timeId       Int
  modalidadeId Int
  ativo        Boolean   @default(true)
  deletedAt    DateTime?

  jogador    Jogador    @relation(fields: [jogadorId], references: [id])
  time       Time       @relation(fields: [timeId], references: [id])
  modalidade Modalidade @relation(fields: [modalidadeId], references: [id])

  @@unique([jogadorId, modalidadeId])
}

model JogadorPartida {
  id               Int     @id @default(autoincrement())
  jogadorId        Int
  partidaId        Int
  timeId           Int
  jogador          Jogador @relation(fields: [jogadorId], references: [id])
  partida          Partida @relation(fields: [partidaId], references: [id])
  time             Time    @relation(fields: [timeId], references: [id])
  gols             Int     @default(0)
  cartoesAmarelos  Int     @default(0)
  cartoesVermelhos Int     @default(0)
  emCampo          Boolean @default(true)

  @@index([partidaId])
  @@index([timeId])
}

model FuncaoJogador {
  id           Int        @id @default(autoincrement())
  nome         String
  modalidadeId Int
  modalidade   Modalidade @relation(fields: [modalidadeId], references: [id])
  jogadores    Jogador[]
}

model PartidaUsuario {
  id          Int       @id @default(autoincrement())
  partidaId   Int
  usuarioId   Int
  permissaoId Int
  partida     Partida   @relation(fields: [partidaId], references: [id])
  usuario     Usuario   @relation(fields: [usuarioId], references: [id])
  permissao   Permissao @relation(fields: [permissaoId], references: [id])
  createdAt   DateTime  @default(now())
}

model Placar {
  id             Int       @id @default(autoincrement())
  campeonatoId   Int
  timeId         Int
  faseId         Int?
  jogos          Int       @default(0)
  posicao        Int       @default(0)
  pontuacao      Int       @default(0)
  vitorias       Int       @default(0)
  empates        Int       @default(0)
  derrotas       Int       @default(0)
  golsPro        Int       @default(0)
  golsSofridos   Int       @default(0)
  saldoDeGols    Int       @default(0)
  aproveitamento Int       @default(0)
  setsVencidos   Int       @default(0)
  vitoria3x0     Int       @default(0)
  vitoria3x2     Int       @default(0)
  derrota2x3     Int       @default(0)
  derrota0x3     Int       @default(0)
  derrotaWo      Int       @default(0)
  visivel        Boolean   @default(true)
  deletedAt      DateTime?

  fase       Fase?      @relation(fields: [faseId], references: [id])
  campeonato Campeonato @relation(fields: [campeonatoId], references: [id])
  time       Time       @relation(fields: [timeId], references: [id])

  @@unique([campeonatoId, faseId, timeId])
}

model UsuarioTime {
  usuarioId Int
  timeId    Int
  ativo     Boolean   @default(true)
  deletedAt DateTime?
  usuario   Usuario   @relation(fields: [usuarioId], references: [id])
  time      Time      @relation(fields: [timeId], references: [id])

  @@id([usuarioId, timeId])
}

model Aviso {
  id        Int      @id @default(autoincrement())
  titulo    String
  descricao String   @db.Text
  foto      String?  @db.VarChar(2048)
  data      DateTime @default(now())
  fixado    Boolean  @default(false)

  quadraId Int?
  quadra   Quadra? @relation(fields: [quadraId], references: [id])

  autorId Int
  autor   Usuario @relation(fields: [autorId], references: [id])

  leituras AvisoLeitura[]
}

model AvisoLeitura {
  id        Int      @id @default(autoincrement())
  lidoEm    DateTime @default(now())
  usuarioId Int
  usuario   Usuario  @relation(fields: [usuarioId], references: [id])
  avisoId   Int
  aviso     Aviso    @relation(fields: [avisoId], references: [id], onDelete: Cascade)

  @@unique([usuarioId, avisoId])
}

model HorarioQuadra {
  id        Int    @id @default(autoincrement())
  quadraId  Int
  diaSemana Int
  horario   String

  quadra Quadra @relation(fields: [quadraId], references: [id])

  @@unique([quadraId, diaSemana, horario])
}
